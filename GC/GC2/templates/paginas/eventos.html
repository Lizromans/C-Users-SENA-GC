{% extends "base.html" %}
{% load static %}
{% block titulo %}Gesti贸n de Eventos{% endblock %}

{% block css %}
<link href="{% static 'css/evento.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block contenido %}{% endblock %}

{% block main %}
<div class="contenedor-principal">

    <!-- ===== TTULO PRINCIPAL ===== -->
    <div class="titulo">
        <h3> Eventos</h3>
        <p>Gestiona, organiza y visualiza todos los eventos acad茅micos de los semilleros de investigaci贸n.</p>
    </div>

    <!-- ===== TARJETAS DE RESUMEN ===== -->
    <div class="info">
        <div class="grupo">
            <div class="card naranja">
                <div class="icon-cont eventos">
                    <img class="icon" src="{% static 'img/calendar.png' %}" alt="Icono Eventos">
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ total_eventos }}</h5>
                    <p>Total de Eventos</p>
                </div>
                <div class="info-badge naranja">
                    <span>+{{ total_mes }} este mes</span>
                </div>
            </div>
        </div>

        <div class="grupo">
            <div class="card azul">
                <div class="icon-cont presenciales">
                    <img class="icon" src="{% static 'img/presencial.png' %}" alt="Icono Presenciales">
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ presenciales }}</h5>
                    <p>Eventos Presenciales</p>
                </div>
                <div class="info-badge azul">
                    <span>+{{ presenciales_mes }} este mes</span>
                </div>
            </div>
        </div>

        <div class="grupo">
            <div class="card verde">
                <div class="icon-cont virtuales">
                    <img class="icon" src="{% static 'img/virtual.png' %}" alt="Icono Virtuales">
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ virtuales }}</h5>
                    <p>Eventos Virtuales</p>
                </div>
                <div class="info-badge verde">
                    <span>+{{ virtuales_mes }} este mes</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SECCIN DE BSQUEDA Y FILTROS ===== -->
    <div class="seccion-busqueda">
        <div class="titulo2">
            <h3>B煤squeda y Filtrados</h3>
        </div>

        <form method="get" class="form-filtros">
            <div class="search-container">
                <input type="text" name="buscar" placeholder="Buscar evento..." class="buscador" value="{{ request.GET.buscar }}">
                <button type="submit" class="search-icon">
                    <i class="fa fa-search"></i>
                </button>
            </div>

            <div class="filtro-estado">
                <label for="estado">Estado:</label>
                <select name="estado" id="estado" class="filtro" onchange="this.form.submit()">
                    <option value="" {% if not request.GET.estado %}selected{% endif %}>Todos</option>
                    <option value="proximo" {% if request.GET.estado == 'proximo' %}selected{% endif %}>Pr贸ximo</option>
                    <option value="en-curso" {% if request.GET.estado == 'en-curso' %}selected{% endif %}>En curso</option>
                    <option value="finalizado" {% if request.GET.estado == 'finalizado' %}selected{% endif %}>Finalizado</option>
                    <option value="programado" {% if request.GET.estado == 'programado' %}selected{% endif %}>Programado</option>
                </select>
            </div>

            <div class="filtro-tipo">
                <label for="tipo">Modalidad:</label>
                <select name="modalidad" id="tipo" class="filtro" onchange="this.form.submit()">
                    <option value="">Todos</option>
                    <option value="presencial" {% if request.GET.modalidad == 'presencial' %}selected{% endif %}>Presencial</option>
                    <option value="virtual" {% if request.GET.modalidad == 'virtual' %}selected{% endif %}>Virtual</option>
                </select>
            </div>

            <div class="botones-item">
                <button type="button" class="limpiar" onclick="window.location.href='{% url 'eventos' %}'">
                    <i class="fas fa-sync-alt"></i> Limpiar filtros
                </button>
            </div>
        </form>
    </div>
    
    <!-- ===== GRID DE EVENTOS ===== -->
    <div class="eventos-section">
        <div class="eventos-header">
            <h3>Lista de Eventos</h3>
            <button type="button" class="btn-agregar" data-bs-toggle="modal" data-bs-target="#modalCrearEvento">
                + Crear Evento
            </button>
        </div>
        
        <div class="eventos-grid">
            {% for evento in eventos %}
                <div class="evento-card {% if evento.estado_eve|lower == 'pr贸ximo' %}estado-proximo
                                        {% elif evento.estado_eve|lower == 'en curso' %}estado-en-curso
                                        {% elif evento.estado_eve|lower == 'finalizado' %}estado-finalizado
                                        {% elif evento.estado_eve|lower == 'cancelado' %}estado-cancelado
                                        {% else %}estado-programado{% endif %}">
                    <div class="evento-estado">
                        {% if evento.estado_eve|lower == 'pr贸ximo' %}
                            <span class="estado-badge proximo">Pr贸ximo</span>

                        {% elif evento.estado_eve|lower == 'en curso' %}
                            <span class="estado-badge en-curso">En Curso</span>

                        {% elif evento.estado_eve|lower == 'finalizado' %}
                            <span class="estado-badge finalizado">Finalizado</span>

                        {% elif evento.estado_eve|lower == 'cancelado' %}
                            <span class="estado-badge cancelado">Cancelado</span>

                        {% else %}
                            <span class="estado-badge programado">Programado</span>
                        {% endif %}
                    </div>

                    <!-- Fecha destacada -->
                    <div class="fecha-box">
                        <span class="fecha-dia">{{ evento.fecha_eve|date:"d" }}</span>
                        <span class="fecha-mes">{{ evento.fecha_eve|date:"b"|upper }}</span>
                    </div>

                    <!-- Badge de modalidad -->
                    <div class="modalidad-badge">
                        {% if evento.modalidad_eve == 'Presencial' %}
                            <span class="badge presencial"> PRESENCIAL</span>
                        {% else %}
                            <span class="badge virtual"> VIRTUAL</span>
                        {% endif %}
                    </div>

                    <!-- Contenido principal -->
                    <div class="evento-content">
                        <h3 class="evento-titulo">{{ evento.nom_eve }}</h3>
                        <p class="evento-descripcion">{{ evento.desc_eve|truncatewords:25 }}</p>

                        <!-- Informaci贸n del evento -->
                        <div class="evento-info">
                            <div class="info-item">
                                <i class="fa fa-calendar"></i>
                                <span>{{ evento.fecha_eve|date:"d-m-Y" }}</span>
                            </div>
                            <div class="info-item">
                                <i class="fa fa-clock"></i>
                                <span>Hora de inicio: {{ evento.hora_inicio }}</span>
                            </div>
                            <div class="info-item">
                                <i class="fa fa-clock"></i>
                                <span>Hora de finalizaci贸n: {{ evento.hora_fin }}</span>
                            </div>
                            <div class="info-item">
                                <i class="fa fa-user"></i>
                                <span>Creado por: {{ evento.cedula.nom_usu }} {{ evento.cedula.ape_usu }}</span>
                            </div>
                            <div class="info-item">
                                {% if evento.modalidad_eve == 'Presencial' %}
                                    <i class="fa fa-map-marker-alt"></i>
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ evento.direccion_eve|urlencode }}" target="_blank" class="evento-link">
                                        {{ evento.direccion_eve }}
                                    </a>
                                {% else %}
                                    <i class="fa fa-video"></i>
                                    <a href="{{ evento.direccion_eve }}" target="_blank" class="evento-link">
                                        {{ evento.direccion_eve }}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acci贸n -->
                    {% if evento.estado_eve != 'Cancelado' and evento.estado_eve != 'Finalizado' %}
                        <div class="botones">
                            <button type="button" class="btn-editar" data-tooltip="Editar" 
                                    data-bs-toggle="modal" data-bs-target="#modalEditarEvento{{ evento.cod_eve }}">
                                <i class="fa fa-edit"></i>
                            </button>

                            <button type="button" class="btn-cancelar" data-tooltip="Cancelar" 
                                    data-bs-toggle="modal" data-bs-target="#modalCancelarEvento{{ evento.cod_eve }}">
                                <i class="fa fa-ban"></i>
                            </button>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p class="no-eventos">No hay eventos disponibles</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- MODAL CREAR EVENTO -->
<div class="modal-overlay-evento" id="modalCrearEvento">
    <div class="modal-dialog-evento">
        <a href="{% url 'eventos' %}" class="modal-cerrar-evento">&times;</a>

        <div class="modal-header-evento">
            <h5 class="modal-title">Crear Nuevo Evento</h5>
        </div>

        <div class="modal-body-evento">
            <form method="POST" action="{% url 'crear_evento' %}">
                {% csrf_token %}

                <div class="row-evento">
                    <div class="col-evento">
                        <label for="nom_eve" class="form-label">Nombre del Evento</label>
                        <input type="text" id="nom_eve" name="nom_eve" maxlength="250" required>
                    </div>

                    <div class="col-evento">
                        <label for="fecha_eve" class="form-label">Fecha del Evento</label>
                        <input type="date" id="fecha_eve" name="fecha_eve" required>
                    </div>

                    <div class="col-evento">
                        <label for="hora_inicio" class="form-label">Hora de Inicio</label>
                        <input type="time" id="hora_inicio" name="hora_inicio" required>
                    </div>

                    <div class="col-evento">
                        <label for="hora_fin" class="form-label">Hora de Fin</label>
                        <input type="time" id="hora_fin" name="hora_fin" required>
                    </div>

                    <div class="col-evento">
                        <label for="modalidad_eve" class="form-label">Modalidad</label>
                        <select id="modalidad_eve" name="modalidad_eve" required>
                            <option value="" selected disabled>Seleccione una opci贸n</option>
                            <option value="Presencial">Presencial</option>
                            <option value="Virtual">Virtual</option>
                        </select>
                    </div>

                    <div class="col-evento">
                        <label for="direccion_eve" class="form-label">Direcci贸n</label>
                        <input type="text" id="direccion_eve" name="direccion_eve" maxlength="250">
                    </div>

                    <div class="col-evento col-evento-full">
                        <label for="desc_eve" class="form-label">Descripci贸n</label>
                        <textarea id="desc_eve" name="desc_eve" rows="3" maxlength="250"></textarea>
                    </div>

                    <input type="hidden" name="estado_eve" value="Programado">
                </div>

                <div class="modal-footer-evento">
                    <a href="{% url 'eventos' %}" class="btn-evento btn-evento-secondary">Cancelar</a>
                    <button type="submit" class="btn-evento btn-evento-primary">Guardar Evento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===== MODALES DE EDITAR EVENTO (uno por cada evento) ===== -->
{% for evento in eventos %}
<div class="modal-overlay-evento" id="modalEditarEvento{{ evento.cod_eve }}">
    <div class="modal-dialog-evento">
        <a href="{% url 'eventos' %}" class="modal-cerrar-evento">&times;</a>

        <div class="modal-header-evento">
            <h5 class="modal-title">Editar Evento</h5>
        </div>

        <div class="modal-body-evento">
            <form method="POST" action="{% url 'editar_evento' evento.cod_eve %}">
                {% csrf_token %}

                <div class="row-evento">
                    <div class="col-evento">
                        <label for="nom_eve{{ evento.cod_eve }}" class="form-label">Nombre del Evento</label>
                        <input type="text" id="nom_eve{{ evento.cod_eve }}" name="nom_eve" maxlength="250" 
                               value="{{ evento.nom_eve }}" required>
                    </div>

                    <div class="col-evento">
                        <label for="fecha_eve{{ evento.cod_eve }}" class="form-label">Fecha del Evento</label>
                        <input type="date" id="fecha_eve{{ evento.cod_eve }}" name="fecha_eve"
                               value="{{ evento.fecha_eve|date:'Y-m-d' }}" required>
                    </div>

                    <div class="col-evento">
                        <label for="hora_inicio{{ evento.cod_eve }}" class="form-label">Hora de Inicio</label>
                        <input type="time" id="hora_inicio{{ evento.cod_eve }}" name="hora_inicio"
                               value="{{ evento.hora_inicio|time:'H:i' }}" required>
                    </div>

                    <div class="col-evento">
                        <label for="hora_fin{{ evento.cod_eve }}" class="form-label">Hora de Fin</label>
                        <input type="time" id="hora_fin{{ evento.cod_eve }}" name="hora_fin"
                               value="{{ evento.hora_fin|time:'H:i' }}" required>
                    </div>

                    <div class="col-evento">
                        <label for="modalidad_eve{{ evento.cod_eve }}" class="form-label">Modalidad</label>
                        <select id="modalidad_eve{{ evento.cod_eve }}" name="modalidad_eve" required>
                            <option value="" disabled>Seleccione una opci贸n</option>
                            <option value="Presencial" {% if evento.modalidad_eve == "Presencial" %}selected{% endif %}>
                                Presencial
                            </option>
                            <option value="Virtual" {% if evento.modalidad_eve == "Virtual" %}selected{% endif %}>
                                Virtual
                            </option>
                        </select>
                    </div>

                    <div class="col-evento">
                        <label for="direccion_eve{{ evento.cod_eve }}" class="form-label">Direcci贸n</label>
                        <input type="text" id="direccion_eve{{ evento.cod_eve }}" name="direccion_eve" maxlength="250"
                               value="{{ evento.direccion_eve }}">
                    </div>

                    <div class="col-evento col-evento-full">
                        <label for="desc_eve{{ evento.cod_eve }}" class="form-label">Descripci贸n</label>
                        <textarea id="desc_eve{{ evento.cod_eve }}" name="desc_eve" rows="3" maxlength="250">{{ evento.desc_eve }}</textarea>
                    </div>

                    <input type="hidden" name="estado_eve" value="{{ evento.estado_eve }}">
                </div>

                <div class="modal-footer-evento">
                    <a href="{% url 'eventos' %}" class="btn-evento btn-evento-secondary">Cancelar</a>
                    <button type="submit" class="btn-evento btn-evento-primary">Actualizar Evento</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- MODALES DE CANCELAR EVENTO -->
{% for evento in eventos %}
<div class="modal-overlay-cancelar" id="modalCancelarEvento{{ evento.cod_eve }}">
    <div class="modal-dialog-cancelar">
        <a href="{% url 'eventos' %}" class="modal-cerrar-evento">&times;</a>

        <div class="modal-header-cancelar">
            <h5 class="modal-title">Cancelar Evento</h5>
        </div>

        <div class="modal-body-cancelar">
            <p class="mensaje-cancelar">
                驴Est谩s seguro de que deseas cancelar el evento <strong>"{{ evento.nom_eve }}"</strong>?<br>
                Esta acci贸n no se puede deshacer.
            </p>
        </div>

        <div class="modal-footer-cancelar">
            <button class="btn-evento btn-cancelarCerrar" onclick="window.location.href='{% url 'eventos' %}'">
                Volver
            </button>

            <form action="{% url 'cancelar_evento' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="cod_eve" value="{{ evento.cod_eve }}">
                <button type="submit" class="btn-evento btn-cancelarEvento">
                    Cancelar Evento
                </button>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<script src="{% static 'js/bootstrap.min.js' %}"></script>
{% endblock %}