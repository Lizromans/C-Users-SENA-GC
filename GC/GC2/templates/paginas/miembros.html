{% extends "base.html" %}
{% load static %}
{% block titulo %} Gestión de Miembros {% endblock %}
{% block css %}
<link href="{% static 'css/miembros.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
{% block contenido %} {% endblock %}
{% block main %}

    <div class="contenedor-principal">
        <div class="titulo">
            <h3>👥 Miembros</h3>
            <p>Aquí podrás consultar y administrar la información detallada de cada uno de los miembros que hacen parte de los semilleros.</p>
        </div>

        <div class="info">
            <div class="grupo">
                <div class="card amarillo">
                    <div class="icon-cont instructores">
                        <img class="icon" src="{% static 'img/instructor.png' %}" alt="Icono Proyectos">
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ total_instructores }}</h5>
                        <p>Instructores</p>           
                    </div>
                </div>
            </div>

            <div class="grupo">
                <div class="card azul">
                    <div class="icon-cont investigadores">
                        <img class="icon" src="{% static 'img/investigador.png' %}" alt="Icono En Desarrollo">
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ total_investigadores }}</h5>
                        <p>Investigadores</p>           
                    </div>
                </div>
            </div>

            <div class="grupo">
                <div class="card morado">
                    <div class="icon-cont aprendiz">
                        <img class="icon" src="{% static 'img/Student.png' %}" alt="Icono Completados">
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ total_aprendices }}</h5>
                        <p>Aprendices</p>           
                    </div>
                </div>
            </div>
        </div>

        <div class="seccion-busqueda">
        
            <div class="titulo2">
                <h3>Filtrados y Vistas</h3>
                <form method="get" class="pildora-vista">
                    <input type="hidden" name="busqueda" value="{{ busqueda }}">
                    <input type="hidden" name="estado" value="{{ estado_filtro }}">
                    <input type="hidden" name="rol" value="{{ rol_filtro }}">
                    
                    <label>
                        <input type="radio" name="vista" value="tarjeta" onchange="this.form.submit()" {% if request.GET.vista == 'tarjeta' or not request.GET.vista %}checked{% endif %}>
                        <span> <img src="{% static 'img/Layout.png' %}" alt="Tarjetas"> Tarjeta</span>
                    </label>
                    <label>
                        <input type="radio" name="vista" value="lista" onchange="this.form.submit()" {% if request.GET.vista == 'lista' %}checked{% endif %}>
                        <span><img src="{% static 'img/Menu.png' %}" alt="Lista">Lista</span>
                    </label>
                </form>
            </div>
            
            <form method="get" class="busqueda-miembros">
                <input type="hidden" name="vista" value="{{ vista }}">
                <input type="hidden" name="estado" value="{{ estado_filtro }}">
                <input type="hidden" name="rol" value="{{ rol_filtro }}">
                
                <label for="search-miembros">Miembros:</label>
                <div class="input-busqueda">
                    <input 
                        type="text" 
                        id="search-miembros" 
                        name="busqueda"
                        placeholder="Todos los miembros"
                        class="input-miembros"
                        value="{{ busqueda }}"
                    >
                </div>
            </form>

            <div class="filtros-rol">
                <label>Rol:</label>
                <div class="botones-rol">
                    <a href="?vista={{ vista }}&estado={{ estado_filtro }}&rol=todos&busqueda={{ busqueda }}" class="btn-rol {% if rol_filtro == 'todos' %}activo{% endif %}" data-estado="todos">Todos</a>
                    <a href="?vista={{ vista }}&estado={{ estado_filtro }}&rol=investigadores&busqueda={{ busqueda }}" class="btn-rol investigadores {% if rol_filtro == 'investigadores' %}activo{% endif %}" data-estado="investigadores">Investigadores</a>
                    <a href="?vista={{ vista }}&estado={{ estado_filtro }}&rol=instructores&busqueda={{ busqueda }}" class="btn-rol instructores {% if rol_filtro == 'instructores' %}activo{% endif %}" data-estado="instructores">Instructores</a>
                    <a href="?vista={{ vista }}&estado={{ estado_filtro }}&rol=aprendices&busqueda={{ busqueda }}" class="btn-rol aprendices {% if rol_filtro == 'aprendices' %}activo{% endif %}" data-estado="aprendices">Aprendices</a>
                </div>
            </div>

            <div class="estado">
                <form method="get">
                    <input type="hidden" name="vista" value="{{ vista }}">
                    <input type="hidden" name="rol" value="{{ rol_filtro }}">
                    <input type="hidden" name="busqueda" value="{{ busqueda }}">
                    
                    <select name="estado" class="filtro" onchange="this.form.submit()">
                        <option value="">Todos los estados</option>
                        <option value="Activo" {% if request.GET.estado == 'Activo' %}selected{% endif %}>Activo</option>
                        <option value="Inactivo" {% if request.GET.estado == 'Inactivo' %}selected{% endif %}>Inactivo</option>
                    </select>
                </form>
            </div>
        </div>

        <!-- Vista de Lista -->
        <div class="lista-container" style="display: {% if request.GET.vista == 'lista' %}block{% else %}none{% endif %};">
            <h3>Lista de Miembros</h3>
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Correo Electrónico</th>
                        <th>Celular</th>
                        <th>Rol</th>
                        <th>Última Sesión</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for miembro in miembros %}
                    <tr>
                        <td class="nombre">{{ miembro.nombres }} {{ miembro.apellidos }}</td>
                        <td>{{ miembro.correo_personal }}</td>
                        <td>{{ miembro.celular }}</td>
                        <td>{{ miembro.rol }}</td>
                        <td>{{ miembro.ultima_sesion|default:"No disponible" }}</td>
                        <td>
                            <a href="?miembro_id={{ miembro.id }}&vista={{ vista }}&estado={{ estado_filtro }}&rol={{ rol_filtro }}&busqueda={{ busqueda }}" class="btn">Ver perfil</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">No hay miembros registrados</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Vista de Tarjetas -->
        <div class="tabla-container" style="display: {% if request.GET.vista == 'lista' %}none{% else %}flex{% endif %};">
            <div class="titulo-tarjeta">
                <h3>Lista de Miembros</h3>
            </div>
            
            <div class="tarjetas-grid">
                {% for miembro in miembros %}
                <div class="grupo">
                    <div class="card {% if miembro.rol == 'Instructor' %}amarillo{% elif miembro.rol == 'Investigador' %}azul{% else %}morado{% endif %}">
                        <div class="icon-cont">
                            <span class="user-icon">
                                <i class="fa fa-user-circle" aria-hidden="true"></i>
                            </span>
                        </div>
                        <div class="card-body">
                            <h5 id="nombre">{{ miembro.nombres }} {{ miembro.apellidos }}</h5>
                            <p id="correo">{{ miembro.correo_personal }}</p>
                            <p id="celular">{{ miembro.celular }}</p>
                        </div>
                        <div class="info-badge">
                            <div class="rol {% if miembro.rol == 'Instructor' %}instructores{% elif miembro.rol == 'Investigador' %}investigadores{% else %}aprendices{% endif %}">
                                <span>{{ miembro.rol }}</span>
                            </div>
                            <div class="ultima-sesion">
                                <span>{{ miembro.ultima_sesion|default:"No disponible" }}</span>
                            </div>
                        </div>
                        <div class="info-icon">
                            <a href="?miembro_id={{ miembro.id }}&vista={{ vista }}&estado={{ estado_filtro }}&rol={{ rol_filtro }}&busqueda={{ busqueda }}">
                                <i class="fa fa-info-circle" aria-hidden="true"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>No hay miembros registrados</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- MODAL DE INFORMACIÓN DEL MIEMBRO -->
    <div id="modalPerfilMiembro" class="modal-perfil-overlay" 
        {% if miembro_seleccionado %}style="display: flex;"{% endif %}>

        <div class="modal-perfil-contenedor">
            <a class="modal-perfil-cerrar" id="btnCerrarPerfilModal" href="{% url 'miembros' %}">
                <i class="fa fa-times"></i>
            </a>

            <div class="perfil-miembro">
                <div class="perfil-miembro-sidebar">
                    <!-- Foto de perfil -->
                    <div class="perfil-foto-contenedor">
                        <img src="{% static 'img/cam.png' %}" alt="foto de perfil" id="perfilFotoImg">
                        <div class="perfil-foto-edit">
                            <img src="{% static 'img/edit.png' %}" alt="Editar foto">
                        </div>
                    </div>

                    <!-- Card de resumen -->
                    <div class="perfil-resumen-card">
                        <h5 class="perfil-resumen-titulo">Resumen</h5>
                        <div class="perfil-resumen-body">
                            <div class="perfil-resumen-fila">
                                <p class="perfil-resumen-label">Estado:</p>
                                <p class="perfil-resumen-valor activo" id="perfilEstado">
                                    {{ miembro_seleccionado.estado|default:"Activo" }}
                                </p>
                            </div>

                            <div class="perfil-resumen-fila">
                                <p class="perfil-resumen-label">Semilleros:</p>
                                <p class="perfil-resumen-numero" id="perfilSemilleros">
                                    {{ miembro_seleccionado.semilleros.count|default:"0" }}
                                </p>
                            </div>

                            <div class="perfil-resumen-fila">
                                <p class="perfil-resumen-label">Proyectos:</p>
                                <p class="perfil-resumen-numero" id="perfilProyectos">
                                    {{ miembro_seleccionado.proyectos.count|default:"0" }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONTENEDOR PRINCIPAL DEL PERFIL -->
                <div class="perfil-informacion-contenedor">
                    <form method="post" action="">
                        {% csrf_token %}

                        <!-- INFORMACIÓN PERSONAL -->
                        <div class="perfil-seccion">
                            <div class="perfil-seccion-titulo">
                                <img src="{% static 'img/User.png' %}" alt="Información Personal">
                                <h6>Información Personal</h6>
                            </div>
                            <hr class="perfil-hr-personal">
                            <div class="perfil-info-grid">
                                <div class="perfil-campo">
                                    <label for="perfilNombres">Nombres:</label>
                                    <input type="text" id="perfilNombres" name="nombres"
                                        value="{{ miembro_seleccionado.nombres }}"readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilApellidos">Apellidos:</label>
                                    <input type="text" id="perfilApellidos" name="apellidos"
                                        value="{{ miembro_seleccionado.apellidos }}" readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilCedula">Cédula:</label>
                                    <input type="text" id="perfilCedula" name="cedula"
                                        value="{{ miembro_seleccionado.cedula }}"readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilCorreoPersonal">Correo Personal:</label>
                                    <input type="email" id="perfilCorreoPersonal" name="correo_personal"
                                        value="{{ miembro_seleccionado.correo_personal|default_if_none:'' }}" readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilCelular">Celular:</label>
                                    <input type="tel" id="perfilCelular" name="celular"
                                        value="{{ miembro_seleccionado.celular|default_if_none:'' }}" readonly>
                                </div>

                                <div class="perfil-campo">
                                    <label for="perfilFechaNacimiento">Fecha de Nacimiento:</label>
                                    <input type="text" id="perfilFechaNacimiento" name="fecha_nacimiento"
                                        value="{{ miembro_seleccionado.fecha_nacimiento|default_if_none:'' }}" readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilEstado">Estado:</label>
                                    <select name="estado" id="perfilEstado" class="perfil-select">
                                        <option value="Activo" {% if miembro_seleccionado.estado == "Activo" %}selected{% endif %}>Activo</option>
                                        <option value="Inactivo" {% if miembro_seleccionado.estado == "Inactivo" %}selected{% endif %}>Inactivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- INFORMACIÓN PROFESIONAL (solo para usuarios) -->
                        {% if tipo_miembro == 'usuario' %}
                        <div class="perfil-seccion">
                            <div class="perfil-seccion-titulo">
                                <img src="{% static 'img/briefcase.png' %}" alt="Información Profesional">
                                <h6>Información Profesional</h6>
                            </div>
                            <hr class="perfil-hr-profesional">
                            <div class="perfil-info-grid">
                                <div class="perfil-campo">
                                    <label for="perfilCorreoSena">Correo Sena:</label>
                                    <input type="email" id="perfilCorreoSena" name="correo_sena"
                                        value="{{ miembro_seleccionado.correo_sena }}"  readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilVinculacion">Vinculación laboral:</label>
                                    <input type="text" id="perfilVinculacion" name="vinculacion"
                                        value="{{ miembro_seleccionado.vinculacion|default_if_none:'' }}" readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilDependencia">Dependencia/Área:</label>
                                    <input type="text" id="perfilDependencia" name="dependencia"
                                        value="{{ miembro_seleccionado.dependencia|default_if_none:'' }}" readonly>
                                </div>
                                <div class="perfil-campo">
                                    <label for="perfilRol">Rol:</label>
                                    <input type="text" id="perfilRol" name="rol"
                                        value="{{ miembro_seleccionado.rol }}" readonly>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- INFORMACIÓN ACADÉMICA (solo para aprendices) -->
                        {% if tipo_miembro == 'aprendiz' %}
                        <div class="perfil-seccion">
                            <div class="perfil-seccion-titulo">
                                <img src="{% static 'img/student.png' %}" alt="Información Académica">
                                <h6>Información Académica</h6>
                            </div>
                            <hr class="perfil-hr-academica">

                            <div class="perfil-info-grid">
                                <div class="perfil-campo">
                                    <label for="perfilCorreoSena">Correo SENA:</label>
                                    <input type="email" id="perfilCorreoSena" name="correo_sena"
                                        value="{{ miembro_seleccionado.correo_sena }}" readonly>
                                </div>

                                <div class="perfil-campo">
                                    <label for="perfilFicha">Ficha:</label>
                                    <input type="text" id="perfilFicha" name="ficha"
                                        value="{{ miembro_seleccionado.ficha }}" readonly>
                                </div>

                                <div class="perfil-campo">
                                    <label for="perfilPrograma">Programa:</label>
                                    <input type="text" id="perfilPrograma" name="programa"
                                        value="{{ miembro_seleccionado.programa }}" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="perfil-seccion">
                            <div class="perfil-seccion-titulo">
                                <img src="{% static 'img/banco.png' %}" alt="Información Bancaria">
                                <h6>Información Bancaria</h6>
                            </div>
                            <hr class="perfil-hr-academica">

                            <div class="perfil-info-grid">
                                <div class="perfil-campo">
                                    <label for="perfilMedioBancario">Medio Bancario:</label>
                                    <input type="text" id="perfilMedioBancario" name="medio_bancario"
                                        value="{{ miembro_seleccionado.medio_bancario }}" readonly>
                                </div>

                                <div class="perfil-campo">
                                    <label for="perfilCuenta">Número de Cuenta:</label>
                                    <input type="text" id="perfilCuenta" name="numero_cuenta"
                                        value="{{ miembro_seleccionado.numero_cuenta }}" readonly>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- INFORMACIÓN DE SEMILLEROS -->
                        <div class="perfil-seccion">
                            <div class="perfil-seccion-titulo">
                                <img src="{% static 'img/microscopio.png' %}" alt="Información de Semilleros">
                                <h6>Información de Semilleros</h6>
                            </div>
                            <hr class="perfil-hr-semilleros">
                            <div class="perfil-info-grid">
                                {% for semillero in miembro_seleccionado.semilleros %}
                                    <div class="perfil-campo">
                                        <input type="text" class="perfil-input-readonly" readonly
                                            value="{{ semillero.sigla }} - {{ semillero.nombre }}">
                                    </div>
                                {% empty %}
                                    <p class="perfil-sin-datos">No está asociado a ningún semillero.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- INFORMACIÓN DE PROYECTOS -->
                        <div class="perfil-seccion">
                            <div class="perfil-seccion-titulo">
                                <img src="{% static 'img/project.png' %}" alt="Información de Proyectos">
                                <h6>Información de Proyectos</h6>
                            </div>
                            <hr class="perfil-hr-proyectos">
                            <div class="perfil-info-grid">
                                {% for proyecto in miembro_seleccionado.proyectos %}
                                    <div class="perfil-campo">
                                        <input type="text" class="perfil-input-readonly" readonly
                                            value="{{ proyecto.nom_pro }}">
                                    </div>
                                {% empty %}
                                    <p class="perfil-sin-datos">No está asociado a ningún proyecto.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <hr class="perfil-hr-final">
                        <button type="submit" class="perfil-btn-guardar">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/bootstrap.min.js' %}"></script>
{% endblock %}